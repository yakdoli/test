# PDF to Markdown 변환기 개발 가이드

## 프로젝트 개요

### 목적
- PDF 파일을 개별 페이지 이미지로 변환
- Ollama의 로컬 LLM(Qwen2.5-VL)을 사용하여 이미지를 마크다운으로 변환
- 한국어 문서 처리에 최적화된 배치 처리 시스템
- Syncfusion SDK 매뉴얼 특화 처리 지원

### 기술 스택
- **언어**: Python 3.10+
- **주요 라이브러리**: pdf2image, Pillow, requests, tqdm, psutil
- **AI 모델**: Ollama Qwen2.5-VL:7b (로컬 실행)
- **외부 의존성**: Poppler (PDF 처리)
- **개발 도구**: argparse (CLI), dataclasses (모델링)

## 개발 규칙 및 컨벤션

### 언어 사용 규칙
- **코드 주석**: 한국어로 작성 (`.kiro/steering/Korean.md` 기준)
- **변수/함수명**: 영어 사용 (Python 표준 관례)
- **문서화**: 한국어로 작성
- **에러 메시지**: 한국어 설명 + 원본 에러 정보
- **기술 용어**: 필요시 영어와 한국어 병행 표기

### 코딩 표준
- **인코딩**: UTF-8 필수 (한국어 처리)
- **문자열**: f-string 사용 권장
- **에러 처리**: try-except 블록으로 명시적 처리
- **진행 상황**: tqdm을 사용한 프로그레스 바 표시
- **타입 힌트**: 가능한 모든 함수에 타입 힌트 추가
- **데이터 모델**: dataclasses 사용 (`modules/models/`)

### 파일 처리 패턴
```python
# 경로 처리는 pathlib.Path 사용
from pathlib import Path
pdf_path = Path("pdfs/example.pdf")

# 파일 인코딩 명시
with open(file_path, 'w', encoding='utf-8') as f:
    f.write(content)

# 데이터 모델 사용 예시
from modules.models.task_models import PDFTask, TaskStatus
task = PDFTask(pdf_path=pdf_path, output_path=output_path)
```

### 임시 파일 관리
- 테스트용 임시 파일은 `tmp_rovodev_` 접두사 사용
- 작업 완료 후 임시 파일 정리 필수

## 프로젝트 구조

### 핵심 파일
- `main.py` - 메인 실행 파일 및 전체 워크플로우 관리
  - `PDFToMarkdownConverter` 클래스: 전체 변환 프로세스 조율
  - 환경 확인, PDF 변환, 마크다운 변환 단계별 실행
- `pdf_converter.py` - PDF → 이미지 변환 모듈
  - `PDFConverter` 클래스: pdf2image를 사용한 페이지별 이미지 변환
  - DPI 설정 및 이미지 형식 지원 (JPEG/PNG)
- `ollama_client.py` - Ollama API 클라이언트 및 이미지 → 마크다운 변환
  - Ollama 서버 연결 및 모델 사용 가능성 확인
  - 이미지를 base64로 인코딩하여 LLM에 전송
  - Syncfusion 특화 후처리 및 코드 스니펫 추출
- `config.py` - 전역 설정 및 경로 관리
  - 경로 설정, Ollama 설정, 이미지 변환 설정
  - Syncfusion 모드 및 성능 최적화 옵션
- `requirements.txt` - Python 의존성 패키지

### 디렉토리 구조
```
.
├── pdfs/           # 원본 PDF 파일들 (입력)
├── staging/        # 변환된 이미지 파일들 (임시, .gitignore에 포함)
├── output/         # 최종 마크다운 파일들 (출력, .gitignore에 포함)
├── modules/        # 새로운 모듈 아키텍처 (개발 중)
│   ├── core/       # 핵심 비즈니스 로직
│   ├── interfaces/ # CLI 및 사용자 인터페이스
│   ├── models/     # 데이터 모델 및 타입 정의
│   └── utils/      # 유틸리티 함수들
├── .kiro/          # 프로젝트 설정 및 개선 계획
│   ├── steering/   # 언어 및 응답 규칙
│   └── specs/      # 기능 개선 명세서
└── tmp_rovodev_*   # 임시 테스트 파일들
```

### 모듈 구조
```
modules/
├── __init__.py
├── core/           # 핵심 비즈니스 로직
├── interfaces/     # CLI 및 사용자 인터페이스
│   └── cli.py     # 명령행 인터페이스 (개발 중)
├── models/         # 데이터 모델 및 타입 정의
│   ├── task_models.py      # 작업 관련 데이터 모델
│   └── progress_models.py  # 진행 상태 모델 (개발 중)
└── utils/          # 유틸리티 함수들
```

### 디렉토리 구조
```
.
├── pdfs/           # 원본 PDF 파일들 (20개, 142.1MB)
├── staging/        # 변환된 이미지 파일들 (✅ 완료: 7,497개 이미지, 1.1GB)
├── output/         # 최종 마크다운 파일들 (출력, 자동 생성)
├── modules/        # 새로운 모듈 아키텍처 (개발 중)
├── .kiro/          # 프로젝트 설정 및 개선 계획
│   ├── steering/   # 언어 및 응답 규칙
│   └── specs/      # 기능 개선 명세서
└── [Python 모듈들]
```

## 개발 환경 설정

### 필수 시스템 의존성
```bash
# Ubuntu/Debian
sudo apt-get install poppler-utils

# macOS
brew install poppler

# Windows
# Poppler for Windows 수동 설치 필요
```

### Python 의존성 설치
```bash
pip install -r requirements.txt
```

### Ollama 설정
```bash
# Ollama 설치 및 실행
curl -fsSL https://ollama.ai/install.sh | sh
ollama serve

# 모델 다운로드 (새 터미널)
ollama pull qwen2.5-vl:7b
```

## 개발 가이드라인

### 언어 사용 규칙 (`.kiro/steering/Korean.md` 기준)
- **코드 주석**: 한국어로 작성
- **변수/함수명**: 영어 사용 (Python 표준 관례)
- **문서화**: 한국어로 작성
- **에러 메시지**: 한국어 설명 + 원본 에러 정보
- **기술 용어**: 필요시 영어와 한국어 병행 표기

### 코딩 표준
- **인코딩**: UTF-8 필수 (한국어 처리)
- **문자열**: f-string 사용 권장
- **에러 처리**: try-except 블록으로 명시적 처리
- **진행 상황**: tqdm을 사용한 프로그레스 바 표시
- **타입 힌트**: 가능한 모든 함수에 타입 힌트 추가

### 아키텍처 패턴
- **데이터 모델**: dataclasses 사용 (`modules/models/`)
- **의존성 주입**: 클래스 생성자를 통한 의존성 전달
- **에러 처리**: 계층적 예외 처리 구조
- **설정 관리**: `config.py`를 통한 중앙 집중식 설정

### 파일 처리 패턴
```python
# 경로 처리는 pathlib.Path 사용
from pathlib import Path
pdf_path = Path("pdfs/example.pdf")

# 파일 인코딩 명시
with open(file_path, 'w', encoding='utf-8') as f:
    f.write(content)

# 데이터 모델 사용 예시
from modules.models.task_models import PDFTask, TaskStatus
task = PDFTask(pdf_path=pdf_path, output_path=output_path)
```

## 설정 관리

### config.py 주요 설정
- `DPI = 200` - PDF → 이미지 변환 해상도 (품질 vs 속도)
- `OLLAMA_MODEL = "qwen2.5vl:latest"` - 사용할 Ollama 모델
- `IMAGE_FORMAT = "PNG"` - 이미지 저장 형식
- `OLLAMA_BASE_URL = "http://localhost:11434"` - Ollama 서버 주소

### 성능 튜닝 가이드
- **고품질 변환**: DPI 300+ (처리 시간 증가)
- **빠른 처리**: DPI 150 (품질 저하)
- **메모리 최적화**: 대용량 PDF는 개별 처리 권장

## 실행 방법

### 전체 PDF 변환
```bash
python main.py
```

### 특정 PDF만 변환
```bash
python main.py "파일명"  # 확장자 제외
```

### 개별 모듈 테스트
```bash
python pdf_converter.py    # PDF 변환 테스트
python ollama_client.py     # Ollama 연결 테스트
```

## 워크플로우 이해

### 1단계: 환경 확인
- PDF 디렉토리 존재 확인
- Ollama 서버 연결 상태 확인
- 모델 사용 가능 여부 확인

### 2단계: PDF → 이미지 변환
- `pdf2image`를 사용하여 페이지별 이미지 생성
- `staging/{pdf_name}/` 디렉토리에 저장
- 파일명 패턴: `page_001.png`, `page_002.png`, ...

### 3단계: 이미지 → 마크다운 변환
- 각 이미지를 base64로 인코딩
- Ollama API를 통해 마크다운 변환
- 페이지별 결과를 하나의 파일로 결합

### 4단계: 결과 저장
- `output/{pdf_name}.md` 파일 생성
- 메타데이터 헤더 추가 (원본 파일명, 변환 일시, 페이지 수)

## 문제 해결 가이드

### 일반적인 오류
1. **Ollama 연결 실패**
   - `ollama serve` 실행 확인
   - 포트 11434 사용 가능 여부 확인

2. **모델 사용 불가**
   - `ollama list`로 설치된 모델 확인
   - `ollama pull qwen2.5-vl:7b`로 재설치

3. **PDF 변환 실패**
   - Poppler 설치 상태 확인
   - PDF 파일 권한 및 손상 여부 확인

4. **메모리 부족**
   - config.py에서 DPI 값 낮추기
   - 대용량 PDF는 개별 처리

### 디버깅 팁
- 각 모듈을 개별 실행하여 문제 지점 파악
- `staging/` 디렉토리의 이미지 파일 확인
- Ollama 로그 확인: `ollama logs`

## Syncfusion SDK 매뉴얼 특화 기능

### 새로운 특화 기능 (v2.0)
- **LLM 미세조정 최적화**: SDK 매뉴얼에 특화된 프롬프트 엔지니어링
- **코드 스니펫 자동 추출**: C#, VB.NET, XML, JavaScript 등 언어별 분류
- **API 문서 구조 보존**: 클래스, 네임스페이스, 메서드 계층 구조 유지
- **RAG 시스템 최적화**: 의미 단위 청킹 및 메타데이터 추가
- **교차 참조 링크**: API 간 연관성 보존

### Syncfusion 모드 설정
```python
# config.py에서 활성화
SYNCFUSION_MODE = True              # Syncfusion SDK 매뉴얼 처리 모드
EXTRACT_CODE_SNIPPETS = True        # 코드 스니펫 별도 추출
PRESERVE_API_STRUCTURE = True       # API 구조 보존
ENABLE_RAG_OPTIMIZATION = True      # RAG 최적화 활성화
INCLUDE_METADATA = True             # 메타데이터 포함
SEMANTIC_CHUNKING = True            # 의미 단위 청킹
CROSS_REFERENCE_LINKS = True        # 교차 참조 링크 생성
```

### 출력 구조 (Syncfusion 모드)
```
output/
├── {pdf_name}.md                   # 메인 마크다운 파일 (메타데이터 포함)
└── code_snippets/{pdf_name}/       # 추출된 코드 스니펫
    ├── csharp_snippets.cs          # C# 코드 스니펫
    ├── vb_snippets.vb              # VB.NET 코드 스니펫
    ├── xml_snippets.xml            # XML/XAML 스니펫
    ├── javascript_snippets.js      # JavaScript 스니펫
    └── css_snippets.css            # CSS 스니펫
```

### 프롬프트 엔지니어링 특징
- **코드 처리**: 정확한 구문, 들여쓰기, 언어 태그 보존
- **API 문서화**: 클래스, 네임스페이스, 메서드, 속성 구조화
- **기술 콘텐츠 향상**: 버전 정보, 호환성, 성능 고려사항 포함
- **RAG 최적화**: 검색 가능한 키워드 및 컨텍스트 추가

### 테스트 및 검증
```bash
# 기능 테스트 (완료됨)
# python tmp_rovodev_test_simple.py

# 데모 실행 (완료됨)
# python tmp_rovodev_demo_syncfusion.py

# 실제 변환 (Syncfusion 모드)
python main.py "DocIo"  # 예시: DocIo.pdf 변환

# 성능 테스트 (common.pdf 기준)
# 2페이지 테스트: 274.7초 (페이지당 137초)
# 전체 145페이지 예상: 5.5시간
```

### 성능 최적화 (common.pdf 테스트 결과)

#### 테스트 결과
- **파일**: common.pdf (145페이지, 5.7MB)
- **테스트**: 첫 2페이지 변환
- **소요 시간**: 274.7초 (페이지당 137초)
- **전체 예상**: 5.5시간
- **주요 병목**: Ollama LLM 응답 시간

#### 최적화 설정 (적용됨)
```python
DPI = 150                    # 200 → 150 (성능 최적화)
IMAGE_FORMAT = "JPEG"        # PNG → JPEG (빠른 처리)
EXTRACT_CODE_SNIPPETS = False # True → False (후처리 생략)
SEMANTIC_CHUNKING = False    # True → False (후처리 생략)
```

#### 추가 최적화 옵션
```bash
# Ultra 최적화 (DPI 100, 2-3시간 예상)
# 품질 저하 있음 - 텍스트 인식률 감소

# 백그라운드 실행 (권장)
nohup python main.py common > common.log 2>&1 &

# 진행 상황 모니터링
tail -f common.log
```

#### 성능 vs 품질 가이드
- **DPI 200**: 최고 품질, 가장 느림 (기준)
- **DPI 150**: 좋은 품질, 2.2배 빠름 (현재 설정)
- **DPI 120**: 적당한 품질, 3배 빠름
- **DPI 100**: 낮은 품질, 4.5배 빠름

## 이미지 변환 스테이징 현황

### ✅ 스테이징 완료 상태
- **총 문서**: 20개 PDF 파일
- **총 이미지**: 7,497개 (모든 페이지 변환 완료)
- **스토리지 사용량**: 1.1GB
- **이미지 형식**: JPEG (DPI 150)
- **무결성**: ✅ 정상 (1개 테스트 파일 정리됨)

### 📊 문서 크기별 분류
- **소형 (<50p)**: 5개 문서 (DICOM, Gauge, PDF Viewer, PivotGrid, ProjIO)
- **중형 (50-200p)**: 7개 문서 (grouping, schedule, QTP, HTMLUI, Olap Common, common, calculate)
- **대형 (200-500p)**: 6개 문서 (diagram, edit, DocIo, pdf, XlsIO, chart)
- **초대형 (500p+)**: 2개 문서 (grid: 1,466p, tools: 2,434p)

### 🚀 마크다운 변환 전략

#### Phase 1: Quick Wins (즉시 실행)
```bash
python main.py DICOM  # 12페이지, 30분 예상
```

#### Phase 2: Short Term (1-5시간)
```bash
nohup python main.py "PDF Viewer" > pdf_viewer.log 2>&1 &
nohup python main.py "Olap Common" > olap_common.log 2>&1 &
nohup python main.py Gauge > gauge.log 2>&1 &
```

#### Phase 3: Medium Term (5-15시간)
```bash
nohup python main.py common > common.log 2>&1 &
nohup python main.py diagram > diagram.log 2>&1 &
```

#### Phase 4: Long Term (15시간+)
```bash
# 주말/야간 실행 권장
nohup python main.py chart > chart.log 2>&1 &    # 24.8시간 예상
nohup python main.py XlsIO > xlsio.log 2>&1 &    # 17.3시간 예상
```

#### Phase 5: Massive (50시간+)
```bash
# 특별 처리 필요 - DPI 추가 감소 또는 배치 분할 고려
# grid: 1,466페이지 (55.9시간 예상)
# tools: 2,434페이지 (92.8시간 예상)
```

### 📈 진행 상황 모니터링
```bash
# 실행 중인 프로세스 확인
ps aux | grep "python main.py"

# 로그 실시간 확인
tail -f *.log

# 완료된 문서 확인
ls -la output/*.md
```

## 개발 로드맵 및 개선 계획

### 현재 개발 상태
- ✅ **기본 변환 기능**: PDF → 이미지 → 마크다운 변환 완료
- ✅ **Syncfusion 특화**: SDK 매뉴얼 처리 최적화 완료
- ✅ **데이터 모델**: 작업 관리 모델 구조 정의 완료
- 🚧 **병렬 처리**: 멀티프로세싱/멀티스레딩 구현 중
- 🚧 **CLI 개선**: argparse 기반 명령행 인터페이스 개발 중
- 📋 **체크포인트**: 작업 재시작 및 복구 기능 계획됨
- 📋 **성능 모니터링**: 리소스 사용량 추적 및 최적화 계획됨

### 주요 개선 사항 (`.kiro/specs/` 참조)
1. **병렬 처리 엔진**: 여러 PDF 및 페이지 동시 처리
2. **향상된 CLI**: 도움말, 모드 선택, 진행 상황 표시
3. **체크포인트 시스템**: 중단된 작업 재시작 지원
4. **성능 모니터링**: CPU/메모리 사용량 추적 및 자동 최적화
5. **오류 처리 개선**: 자동 재시도 및 복구 메커니즘
6. **진행 상황 표시**: 다중 레벨 프로그레스 바 및 ETA 계산

### 아키텍처 진화
```
현재: main.py → PDFConverter → OllamaClient
목표: CLI → TaskManager → ParallelProcessor → [Workers]
                     ├── CheckpointManager
                     ├── ProgressTracker
                     └── PerformanceMonitor
```

## 개발 워크플로우

### 실행 방법
```bash
# 전체 PDF 변환
python main.py

# 특정 PDF만 변환
python main.py "파일명"  # 확장자 제외

# 개별 모듈 테스트
python pdf_converter.py    # PDF 변환 테스트
python ollama_client.py     # Ollama 연결 테스트
```

### 환경 설정 체크리스트
1. **Python 의존성**: `pip install -r requirements.txt`
2. **시스템 의존성**: Poppler 설치 (Ubuntu: `apt-get install poppler-utils`)
3. **Ollama 설정**: 
   - `ollama serve` (서버 시작)
   - `ollama pull qwen2.5-vl:7b` (모델 다운로드)
4. **디렉토리 구조**: `pdfs/` 디렉토리에 PDF 파일 배치

### 주요 설정 옵션 (config.py)
```python
# 성능 vs 품질 조정
DPI = 150                    # 이미지 해상도 (150=빠름, 200=품질)
IMAGE_FORMAT = "JPEG"        # JPEG=빠름, PNG=품질

# Ollama 설정
OLLAMA_BASE_URL = "http://localhost:11434"
OLLAMA_MODEL = "qwen2.5vl:latest"

# Syncfusion 특화 모드
SYNCFUSION_MODE = True              # SDK 매뉴얼 처리 모드
EXTRACT_CODE_SNIPPETS = False       # 코드 스니펫 별도 추출
PRESERVE_API_STRUCTURE = True       # API 구조 보존
```

## 기여 가이드

### 개발 시 체크리스트
- [ ] 한국어 주석 작성 (`.kiro/steering/Korean.md` 준수)
- [ ] UTF-8 인코딩 사용
- [ ] 타입 힌트 추가
- [ ] 에러 처리 구현 (try-except 블록)
- [ ] 진행 상황 표시 (tqdm 사용)
- [ ] 데이터 모델 활용 (`modules/models/`)
- [ ] 개별 모듈 테스트 가능
- [ ] 문서 업데이트 (필요시)

### 테스트 전략
1. **단위 테스트**: 개별 모듈 기능 검증
2. **통합 테스트**: 전체 워크플로우 검증
3. **성능 테스트**: 병렬 처리 및 메모리 사용량 검증
4. **호환성 테스트**: 다양한 PDF 형식 지원 확인
5. **에러 시나리오**: 네트워크 오류, 메모리 부족 등 예외 상황 테스트

### 문제 해결 가이드
1. **Ollama 연결 실패**
   - `ollama serve` 실행 확인
   - 포트 11434 사용 가능 여부 확인
2. **모델 사용 불가**
   - `ollama list`로 설치된 모델 확인
   - `ollama pull qwen2.5-vl:7b`로 재설치
3. **PDF 변환 실패**
   - Poppler 설치 상태 확인
   - PDF 파일 권한 및 손상 여부 확인
4. **메모리 부족**
   - config.py에서 DPI 값 낮추기
   - 대용량 PDF는 개별 처리

### 임시 파일 관리
- 테스트용 임시 파일은 `tmp_rovodev_` 접두사 사용
- 작업 완료 후 임시 파일 정리 필수